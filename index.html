<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>買い物リスト</title>
<style>
  :root{
    --bg: #0f1724;
    --surface: #0b1220;
    --card: #0f1724;
    --muted: #9aa4b2;
    --text: #e6eef8;
    --accent: #7c5cff;
    --accent-2: #5865F2;
    --accent-foreground: #ffffff;
    --success: #27ae60;
    --danger: #e74c3c;
    --glass: rgba(255,255,255,0.03);
    --radius: 12px;
  }

  /* Page layout */
  html,body{height:100%;}
  body {
    font-family: Inter, 'Segoe UI', system-ui, -apple-system, 'Helvetica Neue', Arial;
    background: linear-gradient(180deg,#071025 0%, #081126 60%);
    color: var(--text);
    margin: 0;
    padding: 32px;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* Centered container */
  #root > div {
    max-width: 980px;
    margin: 0 auto;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    padding: 28px;
    border-radius: calc(var(--radius) + 4px);
    box-shadow: 0 8px 30px rgba(2,6,23,0.6);
    backdrop-filter: blur(6px);
  }

  h1{
    margin:0 0 18px 0;
    font-size:1.6rem;
    font-weight:600;
    text-align:center;
    color: var(--text);
    letter-spacing: -0.5px;
  }

  /* Tabs */
  .tabs{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
    justify-content:center;
    margin-bottom:18px;
  }
  .tab{
    padding:8px 14px;
    border-radius:999px;
    cursor:pointer;
    background: transparent;
    color:var(--text);
    border:1px solid rgba(255,255,255,0.04);
    transition: all .18s ease;
    font-size:0.95rem;
  }
  .tab:hover{ transform:translateY(-2px); color:var(--text); border-color:rgba(124,92,255,0.16); }
  .tab.active{
    background:linear-gradient(90deg,var(--accent),var(--accent-2));
    color:#fff;
    box-shadow: 0 6px 18px rgba(255, 255, 255, 0.18);
  }
  [data-theme="light"] .tab { color: #222; }
  [data-theme="light"] .tab.active { color: #fff; }
  [data-theme="dark"] .tab { color: #e6eef8; }
  [data-theme="dark"] .tab.active { color: #fff; }

  /* Buttons */
  button{ margin:4px; padding:8px 12px; border-radius:10px; border:none; display:inline-flex; align-items:center; gap:8px; cursor:pointer; font-weight:600; font-size:0.9rem; }
  .add-btn{ background:linear-gradient(180deg,#4fb3ff,#1e90ff); color:white; }
  .add-btn:hover{ filter:brightness(.98); }
  .delete-btn{ background:linear-gradient(180deg,#ff7b84,#e74c3c); color:white; }
  .delete-btn:hover{ filter:brightness(.98); }
  .restore-btn{ background:linear-gradient(180deg,#7be7a4,#27ae60); color:#05230a; }
  .restore-btn:hover{ filter:brightness(.98); }
  .share-btn{ background:linear-gradient(180deg,#6f7bff,#5865F2); color:white; border-radius:10px; }

  /* List area */
  h2{ margin:12px 0; color:var(--text); font-size:1.1rem; }

  ul{ list-style:none; padding-left:0; margin:0; }
  .item-card{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    padding:12px;
    margin-bottom:12px;
    border-radius:var(--radius);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    box-shadow: 0 6px 18px rgba(3,8,22,0.6);
    border: 1px solid rgba(255,255,255,0.02);
    transition: transform .12s ease, box-shadow .12s ease;
  }
  .item-card:hover{ transform:translateY(-4px); box-shadow:0 12px 36px rgba(8,10,30,0.6); }

  .item-info{ display:flex; align-items:center; gap:12px; min-width:0; }
  .item-info img{ width:44px; height:44px; border-radius:8px; background:var(--glass); object-fit:cover; }

  .item-text{ display:flex; flex-direction:column; min-width:0; }
  .item-text a{ color:var(--text); font-weight:700; text-decoration:none; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:420px; }
  .item-text small{ color:var(--muted); font-weight:500; display:block; margin-top:4px; }

  /* checkbox area and small controls */
  .item-text div{ margin-top:8px; font-size:0.85rem; color:var(--muted); }

  /* right side controls */
  .item-card > button.delete-btn{ padding:10px; border-radius:10px; }

  /* totals */
  h3{ margin-top:16px; color:var(--text); font-size:1.05rem; }

  /* inputs */
  input[type=number]{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--text); padding:6px 8px; border-radius:8px; }

  /* responsive */
  @media (max-width:720px){
    #root > div{ padding:18px; }
    .item-text a{ max-width:200px; }
    .tabs{ justify-content:flex-start; overflow:auto; padding-bottom:6px; }
  }

  /* Accessibility focus */
  .tab:focus, button:focus, input:focus{ outline:3px solid rgba(124,92,255,0.18); outline-offset:2px; }

  /* Light theme overrides */
  [data-theme="light"]{
    --bg: #f6f8fb;
    --surface: #ffffff;
    --card: #ffffff;
    --muted: #55606a;
    --text: #0b1220;
    --accent: #7c5cff;
    --accent-2: #5865F2;
    --glass: rgba(2,6,23,0.03);
  }
  [data-theme="light"] body{
    background: linear-gradient(180deg,#f8fafc 0%, #f6f8fb 60%);
    color: #0b1220;
  }
  [data-theme="light"] #root > div{
    background: linear-gradient(180deg, rgba(2,6,23,0.02), transparent);
    box-shadow: 0 6px 18px rgba(12,17,23,0.06);
  }
  [data-theme="light"] h1{ color: #0b1220; }
  [data-theme="light"] .tab:hover{ color:#0b1220; }
  [data-theme="light"] .tab{ color:var(--muted); border-color: rgba(11,17,30,0.06); }
  [data-theme="light"] .tab:hover{ color:#0b1220; border-color: rgba(124,92,255,0.08); }
  [data-theme="light"] .item-card{ box-shadow: 0 6px 18px rgba(11,17,30,0.04); border:1px solid rgba(11,17,30,0.03); }
  [data-theme="light"] input[type=number]{ border-color: rgba(11,17,30,0.06); color:#27313a; }

  /* Theme toggle button styles */
  .theme-btn{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:inherit; padding:8px; border-radius:8px; }
  .theme-btn:hover{ transform:translateY(-2px); }
  .auto-theme-btn{ background:transparent; border:1px dashed rgba(255,255,255,0.04); color:var(--muted); padding:8px 10px; border-radius:8px; font-size:0.85rem; }
  .auto-theme-btn.active{ background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:white; border:none; }
</style>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>

</head>
<body>
<div id="root"></div>

<script type="text/babel">

function App() {
  const [lists, setLists] = React.useState(() => JSON.parse(localStorage.getItem("lists") || "[]"));
  const [currentList, setCurrentList] = React.useState(lists[0] || null);
  const [trash, setTrash] = React.useState([]);
  const [shipping, setShipping] = React.useState("");
  const [theme, setTheme] = React.useState(() => localStorage.getItem('theme') || 'dark');
  const [autoTheme, setAutoTheme] = React.useState(() => localStorage.getItem('themeAuto') === 'true');

  // ローカル保存
  React.useEffect(() => { localStorage.setItem("lists", JSON.stringify(lists)); }, [lists]);

  // リスト切り替え自動更新
  React.useEffect(() => {
    if (currentList) {
      const updated = lists.find(l => l.name === currentList.name);
      if (updated) setCurrentList(updated);
      else setCurrentList(lists[0] || null);
    } else {
      setCurrentList(lists[0] || null);
    }
  }, [lists]);

  // URLから共有データを読み込み
  React.useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const dataParam = params.get("data");
    if (dataParam) {
      try {
        const decoded = decodeURIComponent(atob(dataParam));
        const importedLists = JSON.parse(decoded);
        if (Array.isArray(importedLists)) {
          setLists(importedLists);
          setCurrentList(importedLists[0] || null);
          alert("共有データを読み込みました！");
        }
      } catch (e) {
        console.error("データ読み込み失敗:", e);
      }
    }
  }, []);

  // テーマの適用 (手動 or 自動)
  React.useEffect(() => {
    try{
      if (autoTheme) {
        const mq = window.matchMedia('(prefers-color-scheme: dark)');
        const apply = (m) => {
          const isDark = m && typeof m.matches === 'boolean' ? m.matches : mq.matches;
          const t = isDark ? 'dark' : 'light';
          document.documentElement.setAttribute('data-theme', t);
          setTheme(t);
          localStorage.setItem('theme', t);
        };
        apply(mq);
        const handler = (e) => apply(e);
        if (mq.addEventListener) mq.addEventListener('change', handler); else mq.addListener(handler);
        return () => { if (mq.removeEventListener) mq.removeEventListener('change', handler); else mq.removeListener(handler); };
      } else {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
      }
    }catch(e){ console.error('theme apply error', e); }
  }, [autoTheme, theme]);

  function toggleTheme(){
    const next = theme === 'dark' ? 'light' : 'dark';
    setTheme(next);
    localStorage.setItem('theme', next);
    document.documentElement.setAttribute('data-theme', next);
  }

  function toggleAutoTheme(){
    const next = !autoTheme;
    setAutoTheme(next);
    localStorage.setItem('themeAuto', next);
  }

  // ---------------------------
  // 各種操作関数
  // ---------------------------
  function addList() {
    const name = prompt("リスト名を入力:");
    if (!name) return;
    const newLists = [...lists, { name, items: [] }];
    setLists(newLists);
    setCurrentList(newLists[newLists.length-1]);
  }

  function deleteList() {
    if (!currentList) return;
    if (!confirm(`リスト「${currentList.name}」を削除しますか？`)) return;
    setLists(lists.filter(l => l.name !== currentList.name));
    setCurrentList(null);
  }

  function addItem() {
    if(!currentList) return;
    const name = prompt("商品名:");
    const url = prompt("URL:");
    const price = prompt("値段:");
    const memo = prompt("メモ:");
    const option = prompt("メモ2:");
    if (!name && !url && !price) return;
    const newItem = { id: Date.now(), name, url, price, memo, option, exclude: false };
    setLists(lists.map(list =>
      list.name === currentList.name
        ? { ...list, items: [...list.items, newItem] }
        : list
    ));
  }

  function deleteItem(id) {
    if(!currentList) return;
    const deletedItem = currentList.items.find(i => i.id === id);
    setLists(lists.map(list =>
      list.name === currentList.name
        ? { ...list, items: list.items.filter(i => i.id !== id) }
        : list
    ));
    setTrash([...trash, deletedItem]);
  }

  function restoreItem() {
    if (trash.length === 0) return;
    const item = trash[trash.length - 1];
    const listName = prompt("復元先のリスト名を入力:");
    if (!listName) return;
    setLists(lists.map(list =>
      list.name === listName
        ? { ...list, items: [...list.items, item] }
        : list
    ));
    setTrash(trash.slice(0, -1));
  }

  function generateShareLink() {
  const data = JSON.stringify(lists);
  const compressed = LZString.compressToEncodedURIComponent(data);
  const url = `${window.location.origin}${window.location.pathname}#data=${compressed}`;
  navigator.clipboard.writeText(url);
  alert("共有URLをコピーしました！\n" + url);
}

// ページ読み込み時に復元
React.useEffect(() => {
  const hash = window.location.hash;
  if (hash.startsWith("#data=")) {
    try {
      const compressed = hash.slice(6);
      const decoded = LZString.decompressFromEncodedURIComponent(compressed);
      const importedLists = JSON.parse(decoded);
      if (Array.isArray(importedLists)) {
        setLists(importedLists);
        setCurrentList(importedLists[0] || null);
        alert("共有データを読み込みました！");
      }
    } catch(e) { console.error(e); }
  }
}, []);

function base64UrlEncode(str) {
  return btoa(unescape(encodeURIComponent(str)))
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=+$/, '');
}


  // 並び替え
  const dragStartIndex = React.useRef(null);
  function handleDragStart(e,index){ dragStartIndex.current = index; }
  function handleDrop(e,index){
    e.preventDefault();
    const newLists=[...lists];
    const dragged=newLists.splice(dragStartIndex.current,1)[0];
    newLists.splice(index,0,dragged);
    setLists(newLists);
  }
  function handleDragOver(e){ e.preventDefault(); }

  // アイコン群
  const PlusIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3z"/></svg>);
  const TrashIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1z"/></svg>);
  const RestoreIcon = () => (<svg stroke="currentColor" fill="none" strokeWidth="3" viewBox="0 0 22 22" strokeLinecap="round" strokeLinejoin="round" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M3.06 13a9 9 0 1 0 .49 -4.087"></path><path d="M3 4.001v5h5"></path></svg>);
  const ShareIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.5 2.5 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5"/></svg>);
  const SunIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M6.76 4.84l-1.8-1.79L3.17 4.84l1.79 1.8 1.8-1.8zM1 13h3v-2H1v2zm10-9h2V1h-2v3zm7.04 1.05l1.79-1.8-1.79-1.79-1.8 1.79 1.8 1.8zM17.24 19.16l1.8 1.79 1.79-1.79-1.79-1.8-1.8 1.8zM20 11v2h3v-2h-3zM12 7a5 5 0 100 10 5 5 0 000-10zM4.24 19.16l1.8-1.8-1.8-1.79-1.79 1.79 1.79 1.8z"/></svg>);
  const MoonIcon = () => (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>);

  const total = currentList 
    ? currentList.items.filter(i => !i.exclude).reduce((acc, i) => acc + (Number(i.price)||0), 0) + (Number(shipping)||0)
    : 0;

  return (
    <div>
      <h1>買い物リスト</h1>
      <div className="tabs">
        {lists.map((list,index)=>(
          <div
            key={list.name}
            className={
                "tab" + ((currentList && currentList.name === list.name) ? " active" : "")
            }
            draggable
            onDragStart={e => handleDragStart(e, index)}
            onDragOver={handleDragOver}
            onDrop={e => handleDrop(e, index)}
            onClick={() => setCurrentList(list)}
            >
            {list.name}
        </div>

        ))}
  <button className="restore-btn" onClick={restoreItem}><RestoreIcon /></button>
  <button className="add-btn" onClick={addList}><PlusIcon /></button>
  <button className="delete-btn" onClick={deleteList}><TrashIcon /></button>
  <button className="theme-btn" onClick={toggleTheme} title="テーマ切替">{theme === 'dark' ? <SunIcon/> : <MoonIcon/>}</button>
  <button className={"auto-theme-btn" + (autoTheme?" active":"")} onClick={toggleAutoTheme} title="自動テーマ">Auto</button>
  <button className="share-btn" style={{backgroundColor:"#5865F2"}} onClick={generateShareLink}><ShareIcon /></button>
      </div>

      {currentList && (
        <div>
          <h2>{currentList.name}</h2>
          <button className="add-btn" onClick={addItem}><PlusIcon /></button>
          <div style={{margin: "10px 0"}}>
            送料: <input type="number" value={shipping} onChange={e=>setShipping(e.target.value)} placeholder="0" style={{width: "80px"}} /> 円
          </div>
          <ul>
            {currentList.items.map(item=>{
              let domain="";
              try{ domain=item.url?new URL(item.url).hostname:""; }catch(e){}
              return (
                <li key={item.id} className="item-card">
                  <div className="item-info">
                    {domain && <img src={`https://www.google.com/s2/favicons?domain=${domain}`} alt="favicon"/>}
                    <div className="item-text">
                      <a href={item.url} target="_blank" rel="noopener noreferrer">{item.name}</a>
                      <small>{item.price?`¥${item.price} / `:""}{item.memo} {item.option}</small>
                      <div>
                        計算に含めない <input type="checkbox" checked={item.exclude||false} onChange={()=>{
                          const newItems = currentList.items.map(i=>
                            i.id===item.id ? {...i, exclude: !i.exclude} : i
                          );
                          setLists(lists.map(l => l.name===currentList.name?{...l, items: newItems}:l));
                        }} />
                      </div>
                    </div>
                  </div>
                  <button className="delete-btn" onClick={()=>deleteItem(item.id)}><TrashIcon /></button>
                </li>
              );
            })}
          </ul>
          <h3>合計: ¥{total.toLocaleString()}</h3>
        </div>
      )}
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);
</script>
</body>
</html>
